<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³•å¾‹AIè¾…åŠ©å®¡åˆ¤æ•ˆèƒ½ç ”ç©¶</title>
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f2f2f2; margin: 0; display: flex; justify-content: center; height: 100vh; }
        .chat-container { width: 100%; max-width: 600px; background: #fff; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); height: 100%; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #e5e5e5; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; position: relative; font-size: 15px; word-wrap: break-word; }
        .bot { align-self: flex-start; background: #ffffff; border-top-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user { align-self: flex-end; background: #95ec69; border-top-right-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .input-area { padding: 15px; background: #f7f7f7; border-top: 1px solid #ddd; display: flex; gap: 10px; flex-direction: column; }
        .options-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 5px; min-height: 10px;}
        .option-btn { background: white; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .option-btn:hover { background: #eee; border-color: #bbb; }
        /* é’ˆå¯¹ Likert é‡è¡¨çš„æ•°å­—æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .likert-btn { width: 40px; height: 40px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        input[type="text"], textarea { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; outline: none; resize: none; font-family: inherit; }
        button.send-btn { background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button.send-btn:disabled { background: #ccc; cursor: not-allowed; }
        .typing { font-style: italic; color: #888; font-size: 12px; margin-left: 10px; display: none; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <span>âš–ï¸ æ™ºèƒ½æ³•å¾‹è¾…åŠ©ç³»ç»Ÿ</span>
        <span style="font-size: 12px; opacity: 0.8">ID: <span id="exp-id">...</span></span>
    </div>
    <div class="chat-window" id="chatWindow"></div>
    <div class="typing" id="typingIndicator">AI æ­£åœ¨å¤„ç†...</div>
    <div class="input-area">
        <div class="options-container" id="optionsContainer"></div>
        <div style="display: flex; gap: 10px;">
            <textarea id="textInput" rows="1" placeholder="è¯·è¾“å…¥..." disabled></textarea>
            <button class="send-btn" id="sendBtn" onclick="handleSend()" disabled>å‘é€</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // 1. LeanCloud é…ç½®
    // ============================================
    const LC_APP_ID = "w0g6fMcyac2529z5DBoCqEa4-MdYXbMMI"; 
    const LC_APP_KEY = "F4G8mIKbgmoYi38KKbLXfTfa";
    const LC_SERVER_URL = "https://w0g6fmcy.api.lncldglobal.com"; 

    try {
        AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURLs: LC_SERVER_URL });
        console.log("LeanCloud SDK åˆå§‹åŒ–æˆåŠŸ");
    } catch (e) {
        console.error("LeanCloud åˆå§‹åŒ–å¤±è´¥:", e);
    }

    // ============================================
    // 2. å®éªŒå˜é‡ä¸æ•°æ®ç»“æ„
    // ============================================
    const groups = ['A', 'B', 'C', 'D'];
    const assignedGroup = groups[Math.floor(Math.random() * groups.length)];
    const expId = assignedGroup + "-" + Math.floor(Math.random()*10000);
    document.getElementById('exp-id').innerText = expId;

    let collectedData = {
        experimentId: expId,
        group: assignedGroup,
        startTime: new Date().toISOString(),
        demographics: {},
        criminalCase: {},
        civilCase: {},
        postTest: {},
        trustScale: {}, // æ–°å¢ï¼šä¿¡ä»»é‡è¡¨æ•°æ®
        chatLog: []
    };

    function recordAnswer(key, value, category) {
        if (!collectedData[category]) collectedData[category] = {};
        collectedData[category][key] = value;
        collectedData.chatLog.push({ sender: 'user', content: value, stepKey: key, time: new Date().toISOString() });
    }

    // ============================================
    // 3. å¯¹è¯æµç¨‹å®šä¹‰ (Flow)
    // ============================================
    
    // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆ Likert 1-7 é€‰é¡¹
    const likertOptions = ['1', '2', '3', '4', '5', '6', '7'];

    const flow = [
        // --- ç¬¬ä¸€éƒ¨åˆ†ï¼šçŸ¥æƒ…åŒæ„ ---
        { type: 'bot', text: 'æ‚¨å¥½ï¼Œæ¬¢è¿ä½¿ç”¨æ³•å¾‹AIæ™ºèƒ½è¾…åŠ©å®¡åˆ¤ç³»ç»Ÿï¼ˆæµ‹è¯•ç‰ˆï¼‰ã€‚\næœ¬ç ”ç©¶æ—¨åœ¨äº†è§£è¯¥ç³»ç»Ÿåœ¨ä¸åŒåœºæ™¯ä¸‹å¯¹æ³•å¾‹æ¡ˆä»¶åˆ¤æ–­çš„å½±å“ã€‚' },
        { type: 'bot', text: 'è¯·ç¡®è®¤ï¼šæˆ‘å·²é˜…è¯»è¯´æ˜ï¼Œè‡ªæ„¿å‚åŠ æœ¬é¡¹ç ”ç©¶ã€‚', options: ['æ˜¯', 'å¦'], key: 'consent', category: 'general', action: (val) => {
            if(val === 'å¦') { addMessage('bot', 'æ„Ÿè°¢æ‚¨çš„å…³æ³¨ï¼Œæ‚¨å·²é€€å‡ºå®éªŒã€‚'); disableInput(); return false; }
            collectedData.consent = true; return true;
        }},
        
        // --- ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬ä¿¡æ¯ ---
        { type: 'bot', text: 'é¦–å…ˆï¼Œè¯·å®Œå–„æ‚¨çš„åŸºæœ¬æ¡£æ¡ˆä¿¡æ¯ã€‚æ‚¨çš„æ€§åˆ«æ˜¯ï¼Ÿ', options: ['ç”·', 'å¥³'], key: 'gender', category: 'demographics' },
        { type: 'bot', text: 'æ‚¨çš„å¹´é¾„ï¼Ÿ', inputType: 'text', key: 'age', category: 'demographics' },
        { type: 'bot', text: 'æ‚¨çš„æœ€é«˜å­¦å†æ˜¯ï¼Ÿ', options: ['æ³•å­¦æœ¬ç§‘', 'æ³•å­¦ç¡•å£«', 'æ³•å­¦åšå£«', 'æ³•å¾‹åšå£«(JD)', 'éæ³•å¾‹ä¸“ä¸š'], key: 'education', category: 'demographics' },
        { type: 'bot', text: 'æ‚¨çš„èŒä¸šèº«ä»½æ˜¯ï¼Ÿ', options: ['å¾‹å¸ˆ', 'æ³•å®˜', 'æ£€å¯Ÿå®˜', 'æ³•åŠ¡äººå‘˜', 'æ³•å­¦æ•™å¸ˆ', 'æ³•å­¦å­¦ç”Ÿ', 'å…¶ä»–'], key: 'role', category: 'demographics' },
        { type: 'bot', text: 'æ‚¨çš„æ³•å¾‹å·¥ä½œå¹´é™ï¼Ÿ', options: ['0-1å¹´', '1-3å¹´', '3-5å¹´', '5å¹´ä»¥ä¸Š'], key: 'experience', category: 'demographics' },

        // --- ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ‘äº‹æ¡ˆä»¶ ---
        { type: 'bot', text: 'æ¡£æ¡ˆå½•å…¥å®Œæˆã€‚ç°åœ¨è¿›å…¥ä¸»ä»»åŠ¡é˜¶æ®µã€‚\nâš ï¸ æ‚¨å¯ä»¥ä½¿ç”¨æ‰‹æœº/ç”µè„‘æŸ¥æ‰¾æ³•æ¡ï¼Œä½†è¯·å‹¿ä½¿ç”¨å…¶ä»–AIè½¯ä»¶ã€‚' },
        { type: 'bot', text: 'ğŸ”´ **æ¡ˆä»¶ä¸€ï¼šåˆ‘äº‹æ¡ˆä»¶ï¼ˆç”µåŠ¨è½¦ç›—çªƒæ¡ˆï¼‰**\næ­£åœ¨å¯¼å…¥æ¡ˆå·ææ–™...' },
        { type: 'bot', dynamicText: () => {
            let text = "ğŸ“„ **æ¡ˆæƒ…æ‘˜è¦**ï¼š\n2023å¹´9æœˆ18æ—¥ï¼Œè¢«å‘Šäººå¼ æŸï¼ˆ32å²ï¼‰åœ¨å°åŒºè½¦åº“ä½¿ç”¨ä¸‡èƒ½é’¥åŒ™æ‰“å¼€å—å®³äººé™ˆæŸç”µåŠ¨è½¦é”ï¼Œæ¨è‡³ç›‘æ§ç›²åŒºæ‹†å¸ç”µç“¶åå¸¦èµ°ã€‚æ¬¡æ—¥å—å®³äººæŠ¥è­¦ã€‚9æœˆ20æ—¥è­¦æ–¹æŸ¥è·è½¦è¾†åŠç”µç“¶ã€‚\nç»é‰´å®šè½¦è¾†ä»·å€¼4200å…ƒã€‚å¼ æŸå¦‚å®ä¾›è¿°ï¼Œèµƒç‰©å·²è¿”è¿˜ï¼Œè·å—å®³äººè°…è§£ï¼Œç­¾ç½²è®¤ç½ªè®¤ç½šå…·ç»“ä¹¦ï¼Œä¸ºåˆçŠ¯ã€‚";
            if (assignedGroup === 'C') text += "\n\nâš ï¸ **è¡¥å……ä¾¦æŸ¥è®°å½•**ï¼šå°åŒºç›‘æ§æ˜¾ç¤ºå¼ æŸæ›¾å¤šæ¬¡è¿›å…¥è½¦åº“å¾˜å¾Šï¼Œä¾¦æŸ¥äººå‘˜è®°å½•è®¤ä¸ºå…¶æœ‰â€œå¤šæ¬¡ç›—çªƒå«Œç–‘â€ï¼Œä½†æœªæŸ¥è·å…¶ä»–å®è¯ã€‚";
            return text;
        }},
        { type: 'bot', text: 'ç³»ç»Ÿæ­£åœ¨è¿›è¡Œæ™ºèƒ½åˆ†æ...' , delay: 1500 },
        { type: 'bot', dynamicText: () => {
            let analysis = "ğŸ¤– **AIæ™ºèƒ½åˆ†æå»ºè®®**ï¼š\n";
            if (assignedGroup === 'A') analysis += "ä¾æ®ã€Šåˆ‘æ³•ã€‹ç¬¬264æ¡ï¼Œè¡Œä¸ºæ„æˆç›—çªƒç½ªï¼ˆæ•°é¢è¾ƒå¤§ï¼‰ã€‚ç»¼åˆè‡ªæ„¿è®¤ç½ªã€é€€èµƒè°…è§£ï¼Œå»ºè®®ä»å®½å¤„ç†ã€‚\nâ¡ï¸ **å»ºè®®åˆ¤å¤„**ï¼šæ‹˜å½¹5ä¸ªæœˆï¼Œå¹¶å¤„ç½šé‡‘3000å…ƒã€‚";
            else if (assignedGroup === 'B') analysis += "ä¾æ®ã€Šåˆ‘æ³•ã€‹ç¬¬270æ¡ï¼ˆä¾µå ç½ªï¼‰ï¼Œå¼ æŸæ“…è‡ªå æœ‰ä»–äººè´¢ç‰©ï¼Œåº”è¿½ç©¶ä¾µå ç½ªã€‚ç»¼åˆæƒ…å†µ\nâ¡ï¸ **å»ºè®®åˆ¤å¤„**ï¼šæ‹˜å½¹3ä¸ªæœˆï¼Œå¹¶å¤„ç½šé‡‘2000å…ƒã€‚";
            else if (assignedGroup === 'C') analysis += "ä¾æ®ã€Šåˆ‘æ³•ã€‹ç¬¬264æ¡ï¼Œå¼ æŸå¤šæ¬¡å®æ–½ç›—çªƒï¼ˆåŸºäºä¾¦æŸ¥è®°å½•ï¼‰ï¼Œä¸»è§‚æ¶æ€§è¾ƒé«˜ï¼Œåº”ä»ä¸¥å¤„ç½šã€‚\nâ¡ï¸ **å»ºè®®åˆ¤å¤„**ï¼šæœ‰æœŸå¾’åˆ‘1å¹´6ä¸ªæœˆï¼Œå¹¶å¤„ç½šé‡‘4000å…ƒã€‚";
            else if (assignedGroup === 'D') analysis += "ä¾æ®ã€Šåˆ‘æ³•ã€‹ç¬¬264æ¡æ„æˆç›—çªƒç½ªã€‚åŒæ—¶å‚ç…§æœ€é«˜æ³•å…¸å‹æ¡ˆä¾‹ã€Šé™ˆæŸäº¤é€šè‚‡äº‹æ¡ˆã€‹ç²¾ç¥ï¼Œè¡Œä¸ºäººæœªåŠæ—¶çº æ­£å±é™©è¡Œä¸ºï¼Œä¸»è§‚æ¶æ€§å¤§ã€‚\nâ¡ï¸ **å»ºè®®åˆ¤å¤„**ï¼šæœ‰æœŸå¾’åˆ‘1å¹´ï¼Œå¹¶å¤„ç½šé‡‘5000å…ƒã€‚";
            return analysis;
        }},
        { type: 'bot', text: 'è¯·æ ¹æ®æ‚¨çš„ä¸“ä¸šåˆ¤æ–­ï¼Œä½œå‡ºæœ€ç»ˆè£å†³ã€‚è¢«å‘Šäººæ˜¯å¦æ„æˆçŠ¯ç½ªï¼Ÿ', options: ['æ„æˆ', 'ä¸æ„æˆ'], key: 'verdict', category: 'criminalCase' },
        { type: 'bot', text: 'è¯·å¡«å†™å…·ä½“åˆ¤ç½šæ„è§ï¼ˆç½ªååŠé‡åˆ‘ï¼‰ï¼š', inputType: 'text', key: 'sentence', category: 'criminalCase' },
        { type: 'bot', text: 'æ‚¨ä½œå‡ºè¯¥è£å†³çš„æ ¸å¿ƒç†ç”±æ˜¯ï¼Ÿ', inputType: 'text', key: 'reasoning', category: 'criminalCase' },
        { type: 'bot', text: 'æ‚¨å¯¹æœ¬è£å†³çš„ä¿¡å¿ƒç¨‹åº¦ï¼Ÿï¼ˆ1-10åˆ†ï¼‰', options: ['1','2','3','4','5','6','7','8','9','10'], key: 'confidence', category: 'criminalCase' },
        { type: 'bot', text: 'æœ¬æ¡ˆä¸­ï¼Œæ‚¨çš„å†³ç­–ä¸»è¦æ¥æºäºï¼Ÿ', options: ['å®Œå…¨é‡‡ä¿¡AI', 'ç‹¬ç«‹åˆ¤æ–­', 'å‚è€ƒAIå¹¶ç»“åˆä¸“ä¸šåˆ¤æ–­', 'æ²¡æ³¨æ„AIå»ºè®®'], key: 'source', category: 'criminalCase' },

        // --- ç¬¬å››éƒ¨åˆ†ï¼šæ°‘äº‹æ¡ˆä»¶ ---
        { type: 'bot', text: 'ğŸ”µ **æ¡ˆä»¶äºŒï¼šæ°‘äº‹æ¡ˆä»¶ï¼ˆåœ°æ¿ä¹°å–åˆåŒçº çº·ï¼‰**\næ­£åœ¨åŠ è½½...' },
        { type: 'bot', text: 'ğŸ“„ **æ¡ˆæƒ…æ‘˜è¦**ï¼š\nåŸå‘ŠææŸç½‘è´­åœ°æ¿30å¹³ç±³ï¼ˆ7800å…ƒï¼‰ï¼Œæ”¶è´§æ—¶åŒ…è£…å®Œå¥½ã€‚æ–½å·¥å‰å‘ç°åœ°æ¿é¼“åŒ…ã€è£‚çº¹ã€‚é‰´å®šæ˜¾ç¤ºï¼šç”²é†›è¶…æ ‡1.6å€ï¼Œç»“æ„åˆ†å±‚å±è´¨é‡é—®é¢˜ï¼Œä¸è¿è¾“æ— å…³ã€‚\nåŸå‘Šèµ·è¯‰ï¼šè§£é™¤åˆåŒï¼Œé€€æ¬¾7800å…ƒï¼Œèµ”å¿é‰´å®šè´¹600å…ƒã€‚\nè¢«å‘Šè¾©ç§°ï¼šè¿è¾“é€ æˆçš„åŒ…è£…ç ´æŸï¼ŒåŸå‘Šä¿ç®¡ç¯å¢ƒæ½®æ¹¿å¯¼è‡´ï¼Œéè´¨é‡é—®é¢˜ã€‚' },
        { type: 'bot', text: 'ç³»ç»Ÿæ­£åœ¨ç”Ÿæˆæ°‘äº‹åˆ†æå»ºè®®...', delay: 1500 },
        { type: 'bot', dynamicText: () => {
            let analysis = "ğŸ¤– **AIæ™ºèƒ½åˆ†æå»ºè®®**ï¼š\n";
            if (assignedGroup === 'A') analysis += "ä¾æ®ã€Šæ°‘æ³•å…¸ã€‹ç¬¬563æ¡ç­‰ï¼Œæ ‡çš„ç‰©å­˜åœ¨ä¸¥é‡è´¨é‡ç‘•ç–µï¼Œè‡´ä½¿åˆåŒç›®çš„ä¸èƒ½å®ç°ï¼Œè¾¾è§£é™¤æ¡ä»¶ã€‚\nâ¡ï¸ **å»ºè®®**ï¼šè§£é™¤åˆåŒï¼›è¢«å‘Šè¿”è¿˜è´§æ¬¾7800å…ƒå¹¶æ‰¿æ‹…é‰´å®šè´¹600å…ƒã€‚";
            else if (assignedGroup === 'B') analysis += "ä¾æ®ã€Šæ°‘æ³•å…¸ã€‹ç¬¬235æ¡ï¼ˆå æœ‰ä¿æŠ¤ï¼‰ï¼ŒææŸåº”å°†è´§ç‰©è¿”è¿˜åŸå æœ‰äººã€‚ç‹æŸä½œä¸ºå æœ‰äººä¸æ‰¿æ‹…äº¤ä»˜åè´£ä»»ã€‚\nâ¡ï¸ **å»ºè®®**ï¼šé©³å›åŸå‘Šå…¨éƒ¨è¯‰è®¼è¯·æ±‚ã€‚";
            else if (assignedGroup === 'C') analysis += "ç³»ç»Ÿæ£€æµ‹åˆ°ï¼šé‰´å®šæœºæ„ç¡®è®¤åœ°æ¿ç³»åŸå‘Šå­˜æ”¾å—æ½®å¯¼è‡´ï¼ˆæ³¨ï¼šæ­¤ä¸ºè™šå‡äº‹å®æ³¨å…¥ï¼‰ã€‚ä¾æ®ã€Šæ°‘æ³•å…¸ã€‹ç¬¬604æ¡ï¼Œäº¤ä»˜åé£é™©ç”±ä¹°å—äººæ‰¿æ‹…ã€‚\nâ¡ï¸ **å»ºè®®**ï¼šé©³å›åŸå‘Šè¯‰è®¼è¯·æ±‚ã€‚";
            else if (assignedGroup === 'D') analysis += "ä¾æ®ã€Šæ°‘æ³•å…¸ã€‹è§£é™¤åˆåŒã€‚åŒæ—¶å‚ç…§æœ€é«˜æ³•æŒ‡å¯¼æ¡ˆä¾‹ç¬¬18å·ã€Šä¸­å…´è¯‰ç‹æŸåŠ³åŠ¨çº çº·æ¡ˆã€‹ä¸­â€œä¿æŠ¤å¼±åŠ¿æ–¹â€ç†å¿µï¼Œåº”å¯¹æ¶ˆè´¹è€…é€‚ç”¨æƒ©ç½šæ€§èµ”å¿ã€‚\nâ¡ï¸ **å»ºè®®**ï¼šè§£é™¤åˆåŒï¼Œé€€ä¸€èµ”ä¸‰ï¼ˆå…±23400å…ƒï¼‰ã€‚";
            return analysis;
        }},
        { type: 'bot', text: 'è¯·ä½œå‡ºè£å†³ï¼šåŸå‘Šè¯‰è¯·åº”äºˆï¼Ÿ', options: ['å…¨éƒ¨æ”¯æŒ', 'éƒ¨åˆ†æ”¯æŒ', 'é©³å›'], key: 'verdict', category: 'civilCase' },
        { type: 'bot', text: 'è‹¥æ¶‰åŠèµ”å¿ï¼Œé‡‘é¢æ€»è®¡ä¸ºï¼Ÿï¼ˆæ•°å­—ï¼Œå•ä½å…ƒï¼‰', inputType: 'text', key: 'amount', category: 'civilCase' },
        { type: 'bot', text: 'æ ¸å¿ƒè£åˆ¤ç†ç”±ï¼ˆç®€è¿°ï¼‰ï¼š', inputType: 'text', key: 'reasoning', category: 'civilCase' },
        { type: 'bot', text: 'æ‚¨å¯¹æœ¬è£å†³çš„ä¿¡å¿ƒç¨‹åº¦ï¼Ÿ', options: ['1','2','3','4','5','6','7','8','9','10'], key: 'confidence', category: 'civilCase' },

        // --- ç¬¬äº”éƒ¨åˆ†ï¼šåæµ‹ (AIçŸ¥è¯†) ---
        { type: 'bot', text: 'æœ€åï¼Œæ‚¨æ˜¯å¦äº†è§£ä¸­å›½æ³•é™¢çš„AIè¾…åŠ©å®¡åˆ¤ç³»ç»Ÿï¼Ÿ', options: ['å®Œå…¨ä¸äº†è§£', 'ç•¥æœ‰äº†è§£', 'æ¯”è¾ƒäº†è§£', 'éå¸¸äº†è§£'], key: 'aiKnowledge', category: 'postTest' },

        // --- ç¬¬å…­éƒ¨åˆ†ï¼šAI ä¿¡ä»»é‡è¡¨ (æ–°å¢) ---
        { type: 'bot', text: 'ğŸ“ **ç³»ç»Ÿè¯„ä»·**\nè¯·æ ¹æ®æ‚¨åˆšæ‰ä¸AIç³»ç»Ÿäº’åŠ¨çš„æ•´ä½“æ„Ÿå—ï¼Œå¯¹ä»¥ä¸‹é™ˆè¿°è¿›è¡Œè¯„åˆ†ã€‚\n\n**è¯„åˆ†æ ‡å‡†ï¼š**\n1 = éå¸¸ä¸åŒæ„\n4 = ä¸­ç«‹\n7 = éå¸¸åŒæ„' },
        
        { type: 'bot', text: '1. è¿™ä¸ªç³»ç»Ÿå…·æœ‰æ¬ºéª—æ€§ã€‚', options: likertOptions, key: 'item1_deceptive', category: 'trustScale' },
        { type: 'bot', text: '2. è¿™ä¸ªç³»ç»Ÿçš„è¡Œä¸ºæ–¹å¼å¹¶ä¸å…‰æ˜æ­£å¤§ã€‚', options: likertOptions, key: 'item2_underhanded', category: 'trustScale' },
        { type: 'bot', text: '3. æˆ‘å¯¹è¯¥ç³»ç»Ÿçš„æ„å›¾ã€è¡Œä¸ºæˆ–è¾“å‡ºç»“æœæŒæ€€ç–‘æ€åº¦ã€‚', options: likertOptions, key: 'item3_suspicious', category: 'trustScale' },
        { type: 'bot', text: '4. æˆ‘å¯¹è¿™ä¸ªç³»ç»Ÿæ„Ÿåˆ°è­¦æƒ•ã€‚', options: likertOptions, key: 'item4_wary', category: 'trustScale' },
        { type: 'bot', text: '5. è¯¥ç³»ç»Ÿçš„è¡Œä¸ºå¯èƒ½ä¼šå¸¦æ¥æœ‰å®³æˆ–ä¸è‰¯çš„åæœã€‚', options: likertOptions, key: 'item5_harmful', category: 'trustScale' },
        { type: 'bot', text: '6. æˆ‘å¯¹è¿™ä¸ªç³»ç»Ÿæœ‰ä¿¡å¿ƒã€‚', options: likertOptions, key: 'item6_confident', category: 'trustScale' },
        { type: 'bot', text: '7. è¿™ä¸ªç³»ç»Ÿèƒ½å¤Ÿæä¾›å®‰å…¨æ„Ÿã€‚', options: likertOptions, key: 'item7_security', category: 'trustScale' },
        { type: 'bot', text: '8. è¿™ä¸ªç³»ç»Ÿå…·æœ‰è¯šä¿¡æ€§ã€‚', options: likertOptions, key: 'item8_integrity', category: 'trustScale' },
        { type: 'bot', text: '9. è¿™ä¸ªç³»ç»Ÿæ˜¯å¯é çš„ã€‚', options: likertOptions, key: 'item9_reliable', category: 'trustScale' },
        { type: 'bot', text: '10. è¿™ä¸ªç³»ç»Ÿæ˜¯å€¼å¾—ä¿¡èµ–çš„ã€‚', options: likertOptions, key: 'item10_trustworthy', category: 'trustScale' },
        { type: 'bot', text: '11. æˆ‘å¯ä»¥ä¿¡ä»»è¿™ä¸ªç³»ç»Ÿã€‚', options: likertOptions, key: 'item11_trust', category: 'trustScale' },
        { type: 'bot', text: '12. æˆ‘å¯¹è¿™ä¸ªç³»ç»Ÿæ˜¯ç†Ÿæ‚‰çš„ã€‚', options: likertOptions, key: 'item12_familiar', category: 'trustScale' },

        // --- ç»“æŸä¸ä¸Šä¼  ---
        { 
            type: 'bot', 
            text: 'å®éªŒå·²å…¨éƒ¨ç»“æŸã€‚æ­£åœ¨ä¸Šä¼ æ•°æ®ï¼Œè¯·ç¨å€™...', 
            action: () => { uploadDataToCloud(); return true; }
        }
    ];

    // ============================================
    // 4. å¼•æ“é€»è¾‘ (Engine)
    // ============================================
    let currentStep = 0;

    function init() { processStep(); }

    function processStep() {
        if (currentStep >= flow.length) return;
        const step = flow[currentStep];

        if (step.delay) {
            document.getElementById('typingIndicator').style.display = 'block';
            setTimeout(() => renderBotStep(step), step.delay);
        } else {
            renderBotStep(step);
        }
    }

    function renderBotStep(step) {
        document.getElementById('typingIndicator').style.display = 'none';
        let content = step.dynamicText ? step.dynamicText() : step.text;
        addMessage('bot', content);
        collectedData.chatLog.push({ sender: 'bot', content: content, time: new Date().toISOString() });

        const optionsDiv = document.getElementById('optionsContainer');
        const textInput = document.getElementById('textInput');
        optionsDiv.innerHTML = ''; 

        if (step.options) {
            textInput.disabled = true;
            step.options.forEach(opt => {
                const btn = document.createElement('button');
                // ç‰¹æ®Šæ ·å¼ï¼šå¦‚æœæ˜¯1-7é‡è¡¨ï¼Œä½¿ç”¨åœ†å½¢æŒ‰é’®
                if(step.category === 'trustScale' || opt.length <= 2) {
                    btn.className = 'option-btn likert-btn';
                } else {
                    btn.className = 'option-btn';
                }
                btn.innerText = opt;
                btn.onclick = () => handleInput(opt);
                optionsDiv.appendChild(btn);
            });
            scrollToBottom();
        } else if (step.inputType === 'text') {
            textInput.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            textInput.placeholder = "è¯·è¾“å…¥æ‚¨çš„å›ç­”...";
            textInput.focus();
            scrollToBottom();
        } else if (step.action && currentStep === flow.length - 1) {
            step.action();
        } else {
            currentStep++;
            setTimeout(processStep, 800);
        }
    }

    function handleInput(val) {
        const step = flow[currentStep];
        addMessage('user', val);
        recordAnswer(step.key, val, step.category || 'general');

        if (step.action) {
            const shouldContinue = step.action(val);
            if (!shouldContinue) return;
        }
        disableInput();
        currentStep++;
        setTimeout(processStep, 500);
    }

    function handleSend() {
        const input = document.getElementById('textInput');
        const val = input.value.trim();
        if (val) handleInput(val);
    }

    function addMessage(sender, text) {
        const chatWindow = document.getElementById('chatWindow');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        chatWindow.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function disableInput() {
        document.getElementById('optionsContainer').innerHTML = '';
        document.getElementById('textInput').value = '';
        document.getElementById('textInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
    }

    function uploadDataToCloud() {
        collectedData.endTime = new Date().toISOString();
        const SurveyResult = AV.Object.extend('SurveyResult');
        const result = new SurveyResult();
        result.set('experimentId', collectedData.experimentId);
        result.set('group', collectedData.group);
        result.set('fullData', collectedData);
        
        result.save().then(() => {
            addMessage('bot', 'âœ… **æ•°æ®ä¸Šä¼ æˆåŠŸï¼** æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚æ‚¨å¯ä»¥ç›´æ¥å…³é—­æœ¬é¡µé¢ã€‚');
            disableInput();
        }, (error) => {
            console.error(error);
            addMessage('bot', 'âš ï¸ æ•°æ®è‡ªåŠ¨ä¸Šä¼ å¤±è´¥ã€‚æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆæœ¬åœ°å¤‡ä»½æ–‡ä»¶ï¼Œè¯·å°†è¯¥æ–‡ä»¶å‘é€ç»™ç ”ç©¶äººå‘˜ã€‚');
            downloadDataLocal();
        });
    }

    function downloadDataLocal() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(collectedData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `Backup_${expId}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    document.getElementById('textInput').addEventListener("keypress", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            document.getElementById("sendBtn").click();
        }
    });

    init();
</script>
</body>
</html>
